<!DOCTYPE html>
<html lang="zh">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>职位</title>
		<link rel="stylesheet" href="../static/lib/bootstrap-3.3.7-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="../static/css/main.css" />
		<link rel="stylesheet" href="../static/css/position.css" />
		<link rel="stylesheet" href="../static/css/user.css" />
		<link rel="shortcut icon" type="image/x-icon" href="../static/img/favicon.ico" />
	</head>

	<body>
		<!--导航栏 -->
		<div class="navbar navbar-default">
			<div class="container">

				<div class="col-sm-3 navbar-header">
					<a href="index.html" class="navbar-brand"></a>
				</div>

				<ul class="col-sm-7 nav navbar-nav">
					<!--<li class="active"><a href="#">首页</a></li>
						<li><a href="">找职位</a></li>
						<li><a href="#">名企校招</a></li>
						<li><a href="#">宣讲会</a></li>
						<li><a href="#">空中宣讲会</a></li>-->
				</ul>

				<div class="col-sm-2 btn-groupn navbar-right">
					<a class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-user" id="user_name"> </span></a>
					<ul class="dropdown-menu dropdown-menu-left">
						<li>
							<a href="job.html">返回主页</a>
						</li>					
						<li role="separator" class="divider"></li>
						<li>
							<a href="login.html">退出</a>
						</li>
					</ul>
				</div>
			</div>
		</div>

		<div class="container position-top">
			<div class="position-list-item ">
				<div class="col-sm-8">
					<h1 id="position_nameh"></h1>
					<div class="position-info-1 row">
						<div class="col-sm-1 "></div>
						<div class="col-sm-2 position-info-reward"><span class="glyphicon glyphicon-education" id="position_typeh"></span></div>
						<div class="col-sm-5"><span class="glyphicon glyphicon-map-marker" id="position_placeh"></span></div>
					</div>
				</div>
				
				<div class="col-sm-2 position-a " id="position_collect">
					<a href="#" class="btn-store">收藏</a>
				</div>
			</div>
		</div>

		<div class="container">
			<div class="col-sm-8">				
				<div class="user-list">					
					<div class="user-list-item1"><span>|</span> 职位待遇</div>
				</div>
				<div class="position-desc" id="position_treatmenth">
					
				</div>
				
				<div class="position-evaluate" id="evaluate_update_total">
					
                </div>
				
				<div class="position-evaluate" id="evaluate_update">
				
					<div class="user-list" >					
						<div class="user-list-item1"><span>|</span> 请您对此职位推荐做出评价：</div>
					</div>
					<div class="form-group" >                
                        <div class="col-sm-7">
                            <label class="radio-inline">
                                <input type="radio" name="score" value="1" > 1分
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="score" value="2" > 2分
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="score" value="3" > 3分
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="score" value="4" > 4分
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="score" value="5" > 5分
                            </label>
                        </div>
                        <div class="col-sm-2 position-a-bottom">
                    		<button class="position-determine btn-submit" id="evaluate_update_button">确定</button>
                    	</div>
                    </div>
                    
                 </div>  
                   
                   
                            
				</div>
				
			<div class="col-sm-4">
				<div class="company-sketch">
					<div id="company_img">
						
					</div>		
					<h4 id="company_nameh"></h4>
					<p id="company_emailh"></p>
			</div>
		</div>		
		
		<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
		<script src="../static/lib/jquery/jquery-3.4.1.js"></script>
		<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
		<script src="../static/lib/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
		<script>
			var position_grade = ''
			var position_id

			
			$(function(){
				id_build()
				user_judge()
				position_info_add()		
				username_add()
				collect_build()
				get_score()
				get_all_score()
				
				//判断为用户还是公司
				function user_judge(){
					var user = sessionStorage.getItem('user')
					if(user == "公司"){
						$("#evaluate_update").remove()
						$("#position_collect").remove()
					}
				}
				
				//名字显示
				function username_add(){
					var date = sessionStorage.getItem('username')
					$("#user_name").append(date)
				}
				
				//获取链接中id
				function id_build(){
					var href = location.href
					var tol = href.length
					var pos = href.indexOf("=")
					position_id = decodeURI(href.substr(pos+1,tol-pos))
				}
					
				
				//职位信息显示
				function position_info_add(){
					
					var img = ''
					var position_grade
					
					$.ajax({
						type:"get",
						url:"http://127.0.0.1:5000/job/test",
						dataType:"json",
						success:function(result){			
							var job_info = result
							console.log(job_info)
							for(var i = 0; i < job_info.length; i++){
								if(job_info[i].position_id == position_id){							
									$("#position_nameh").append(job_info[i].position_name)
									$("#position_typeh").append(job_info[i].position_type)
									$("#position_placeh").append(job_info[i].position_place)
									$("#position_treatmenth").append(job_info[i].position_treatment)						
									$("#company_nameh").append(job_info[i].company_name)
									$("#company_emailh").append(job_info[i].company_email)
									img += '<img src="'+job_info[i].company_photo+'" />'
									$("#company_img").append(img)
								}
							}
						}
					})
				}
				
				//收藏显示
				function collect_build(){
					
					var username = sessionStorage.getItem('username')
					var data = {
						data:JSON.stringify({
							"username":username,
							"position_id":position_id
						}),			
					}
					console.log(data)
					$.ajax({
						type: "post",
						url: "http://127.0.0.1:5000/user/collect-select",
						dataType: "json",
						async: false,
						data: data,
						success: function(result){
							console.log(result)
							if(result.msg == "yes"){
								$("#position_collect").empty()
								$("#position_collect").append("<a href='#' class='btn-store btn-change'>已收藏</a>")
							}
						}
					});	
				}	
				
				//获取得分数据显示
				function get_score(){
					var username = sessionStorage.getItem('username')
					var data = {
						data:JSON.stringify({
							"username":username,
							"position_id":position_id
						}),			
					}
					console.log(data)
					$.ajax({
						type: "post",
						url: "http://127.0.0.1:5000/user/score-select",
						dataType: "json",
						async: false,
						data: data,						
						success: function(result){	
							if(result.msg != "no"){
								$('#evaluate_update').empty()	
								$('#evaluate_update')
								.append($("<div class='user-list'></div>")
								.append($("<div class='user-list-item1'></div>")
								.append($("<span>|</span>")).append("你对该职位的评分为：").append(result.msg+"分")))	
							}
							
						}
					});	
				}
				
				//获取职位总评分
				function get_all_score(){
					var username = sessionStorage.getItem('username')
					var data = {
						data:JSON.stringify({
							"position_id":position_id
						}),			
					}
					console.log(data)
					$.ajax({
						type: "post",
						url: "http://127.0.0.1:5000/user/score-position-select-all",
						dataType: "json",
						async: false,
						data: data,						
						success: function(result){	
						console.log(result)
							var position_score = result
							var total = 0
							var avg = 0
							for(var i=0; i<position_score.length;i++){							
								total += parseFloat(JSON.stringify(position_score[i].score))
							}
							avg = (total / position_score.length).toFixed(1)
							$('#evaluate_update_total')
							.append($("<div class='user-list'></div>")
							.append($("<div class='user-list-item1'></div>")
							.append($("<span>|</span>")).append("该职位的总评分为：").append(avg+"分")))	
						}
					});	
				}
				
			})
			
			//收藏
			$("#position_collect a").click(function(){
				var username = sessionStorage.getItem('username')
					var data = {
						data:JSON.stringify({
							"username":username,
							"position_id":position_id
						}),			
					}
					console.log(data)
					$.ajax({
						type: "post",
						url: "http://127.0.0.1:5000/user/collect-position",
						dataType: "json",
						async: false,
						data: data,
						success: function(result){
							console.log("success!")
							$("#position_collect").empty()
							$("#position_collect").append("<a href='#' class='btn-store btn-change'>已收藏</a>")
						}
					});			
			})
			
			//评分
			$("#evaluate_update_button").click(function(){
				var username = sessionStorage.getItem('username')
				var score = $('input[name="score"]:checked').val()
				console.log("score="+score)
				var data = {
					data:JSON.stringify({
						"username":username,
						"position_id":position_id,
						"score":score
					}),			
				}
				console.log(data)
				$.ajax({
					type: "post",
					url: "http://127.0.0.1:5000/user/score-add",
					dataType: "json",
					async: false,
					data: data,
					success: function(result){
						console.log("success-evaluate!")
						window.location.reload()		
					}
				});			
			})
									
			
			
											
		</script>
		<!--自己的插件 -->
		<script src="../static/js/index.js"></script>
	</body>

</html>